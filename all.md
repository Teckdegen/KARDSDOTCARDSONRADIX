# Cashwyre API Integration & Webhooks - Complete Documentation

This document provides comprehensive, word-for-word documentation of all Cashwyre API endpoints used in the KARDS platform, when they are called, how they work, and the complete webhook flow.

---

## üì° Cashwyre API Overview

**Base URL:** `https://businessapi.cashwyre.com/api/v1.0`

**Authentication:**
- Method: Bearer Token
- Header: `Authorization: Bearer ${CASHWYRE_SECRET_KEY}`
- All requests use POST method
- Content-Type: `application/json`

**Required Environment Variables:**
- `CASHWYRE_BASE_URL`: Base API URL (default: `https://businessapi.cashwyre.com/api/v1.0`)
- `CASHWYRE_SECRET_KEY`: Bearer token for authentication
- `CASHWYRE_BUSINESS_CODE`: Business code for requests
- `CASHWYRE_APP_ID`: Application ID for requests

**Request ID Format:**
- Pattern: `KARDS` + 12 alphanumeric characters (uppercase letters and numbers only)
- Example: `KARDSA1B2C3D4E5F6`
- Generated by: `generateRequestId()` function
- No dashes, underscores, or special characters

**Request Retry Logic:**
- Automatic retry: 3 attempts
- Exponential backoff: 2^attempt * 1000ms (1s, 2s, 4s delays)
- Only retries on network errors, not on API errors (4xx/5xx)

**Common Request Fields (Auto-filled):**
```json
{
  "appId": "<CASHWYRE_APP_ID>",        // Auto-filled if not provided
  "businessCode": "<BUSINESS_CODE>",    // Auto-filled if not provided
  "requestId": "KARDSxxxxxxxxxxxx"      // Required, manually generated
}
```

---

## üîå Cashwyre API Endpoints

### 1. POST /CustomerCryptoAddress/createCryptoAddress

**Purpose:** Creates a unique Ethereum address for receiving USDC payments that will be used to fund a card.

**When Called:**
- During card creation process (`POST /api/cards/create`)
- When creating a bridge quote for card creation (`POST /api/cards/create/bridge-quote`)
- Only called if no unused Ethereum address exists from previous cancelled card creations

**Call Sequence:**
1. User initiates card creation
2. System checks for unused Ethereum addresses from previous cancelled card creations
3. If no unused address found, calls this API
4. Ethereum address is stored as `card_wallet_address` in `cards` table
5. This address is where funds are bridged to (Flare ‚Üí Ethereum)

**Request Payload:**
```json
{
  "appId": "<CASHWYRE_APP_ID>",
  "businessCode": "<CASHWYRE_BUSINESS_CODE>",
  "requestId": "KARDSA1B2C3D4E5F6",
  "FirstName": "John",
  "LastName": "Doe",
  "Email": "john@example.com",
  "AssetType": "ETH",
  "Network": "USDC",
  "Amount": 0.0001
}
```

**Field Descriptions:**
- `FirstName` (required): User's first name from Supabase `users` table
- `LastName` (required): User's last name from Supabase `users` table
- `Email` (required): User's email address from Supabase `users` table
- `AssetType` (required): Always `"ETH"` - Ethereum network
- `Network` (required): Always `"USDC"` - USDC token on Ethereum
- `Amount` (required): Always `0.0001` - Minimal amount (not used for actual funding)
- `requestId` (required): Unique request ID in format `KARDS` + 12 alphanumeric

**Response:**
```json
{
  "success": true,
  "data": {
    "address": "0x742d35Cc6634C0532925a3b844Bc9e7595f0bEb"
  }
}
```

**Response Fields:**
- `address` (string): Ethereum address where USDC will be received
- This address is unique per card and used for payment tracking

**Usage:**
- The returned Ethereum address is stored as `card_wallet_address` in the `cards` table
- This address is the destination for bridge transactions (funds bridged from Flare to Ethereum)
- Cashwyre monitors this address for incoming USDC payments
- When payment is detected, Cashwyre triggers the payment webhook

**Error Handling:**
- If API call fails, card creation is aborted
- Error is logged and returned to user
- Retry logic (3 attempts with exponential backoff) applies

**Timing:**
- Called during card creation process
- Response time: ~2-3 seconds
- Called synchronously (waits for response before proceeding)

---

### 2. POST /CustomerCard/createCard

**Purpose:** Creates a new physical Visa debit card in Cashwyre's system. This is the final step that actually issues the card after payment has been received.

**When Called:**
- **NOT called directly by user** - called automatically by webhook handler
- Triggered by payment webhook: `stablecoin.usdc.received.success`
- Called in `/api/webhooks/cashwyre-payment` webhook handler
- Only called when:
  1. Payment webhook is received
  2. Card status is "processing" (pending card creation)
  3. `card_code` is null (card not yet created)
  4. Payment amount matches expected amount

**Call Sequence (Complete Flow):**
1. User initiates card creation via `POST /api/cards/create`
2. User's funds are bridged from Flare ‚Üí Ethereum network (takes 5-15 minutes)
3. Funds arrive at `card_wallet_address` (Ethereum address created earlier)
4. Cashwyre detects payment on Ethereum network (usually 1-5 minutes after arrival)
5. Cashwyre sends webhook: `POST /api/webhooks/cashwyre-payment` with event `stablecoin.usdc.received.success`
6. Webhook handler finds pending card by `card_wallet_address`
7. Webhook handler extracts stored `form_data` from `cards` table
8. Webhook handler calls this API (`/CustomerCard/createCard`) with all required data
9. Cashwyre processes card creation (takes 1-5 minutes)
10. Cashwyre sends another webhook: `virtualcard.created.success` when card is ready

**Request Payload:**
```json
{
  "appId": "<CASHWYRE_APP_ID>",
  "businessCode": "<CASHWYRE_BUSINESS_CODE>",
  "requestId": "KARDSB2C3D4E5F6G7",
  "firstName": "John",
  "lastName": "Doe",
  "email": "john@example.com",
  "phoneCode": "+1",
  "phoneNumber": "1234567890",
  "dateOfBirth": "1990-05-15",
  "homeAddressNumber": "123",
  "homeAddress": "Main Street, New York, NY, USA",
  "cardName": "My Personal Card",
  "cardType": "physical",
  "cardBrand": "visa",
  "amountInUSD": 50
}
```

**Field Descriptions:**
- `firstName` (required): User's first name from Supabase `users.first_name`
- `lastName` (required): User's last name from Supabase `users.last_name`
- `email` (required): User's email from Supabase `users.email`
- `phoneCode` (required): Country code - **AUTO-GENERATED RANDOMLY** during card creation (e.g., "+1", "+44", "+234")
- `phoneNumber` (required): Phone number - **AUTO-GENERATED RANDOMLY** during card creation, valid format for selected country code
- `dateOfBirth` (required): Date of birth in format "YYYY-MM-DD" - **AUTO-GENERATED RANDOMLY** (25-65 years old, any month and day)
- `homeAddressNumber` (required): Street number - **AUTO-GENERATED RANDOMLY** based on country code
- `homeAddress` (required): Full address - **AUTO-GENERATED RANDOMLY** based on country code (includes street, city, country)
- `cardName` (required): User-defined card name (from form input)
- `cardType` (required): Always `"physical"` - **HARDCODED**
- `cardBrand` (required): Always `"visa"` - **HARDCODED**
- `amountInUSD` (required): Initial card funding amount in USD (from form input, minimum $15)

**Auto-Generated Data:**
All contact information (phone, address, DOB) is randomly generated by the system during card creation:
- **NOT stored in Supabase** - only used once for this API call
- **NOT shown to user** - user never sees this data
- **Generated in:** `src/app/api/cards/create/route.ts`
- **Stored temporarily:** In `cards.form_data` JSONB column (used by webhook)
- **Deleted/Cleared:** After card creation completes

**Auto-Generation Functions:**
- `getRandomCountryCode()`: Randomly selects country code from worldwide list
- `generatePhoneNumber(phoneCode)`: Generates valid phone number matching country code format
- `generateAddress(phoneCode)`: Generates random street number and full address based on country
- Date of birth: Random date making user 25-65 years old

**Response:**
```json
{
  "success": true,
  "message": "Card creation initiated",
  "data": {
    "cardCode": null  // Card code not available yet, will come via webhook
  }
}
```

**Important Notes:**
- Card code is **NOT** returned in this response
- Card code comes later via `virtualcard.created.success` webhook
- This API call only initiates card creation on Cashwyre's side
- Actual card creation takes 1-5 minutes (asynchronous)
- Status remains "processing" until webhook arrives

**Error Handling:**
- If API call fails, webhook logs error in `webhook_logs` table
- `processed` flag remains `false` for failed webhooks
- Webhook can be manually reprocessed
- Card remains in "processing" status until successful

**Timing:**
- Called automatically by webhook handler (not user-initiated)
- Response time: ~3-5 seconds
- Total time from payment to card creation: 6-20 minutes (payment detection + card processing)

---

### 3. POST /CustomerCard/getCard

**Purpose:** Retrieves complete, real-time card details including balance, last 4 digits, expiry date, and transaction history. This is called every time card details are needed - data is NEVER cached.

**When Called:**
- Every time user views card details page (`GET /api/cards/[cardCode]`)
- Called on-demand when card information is requested
- Called after ownership verification (checking user owns the card)
- Data is fetched fresh every time - never uses cached data from Supabase

**Call Sequence:**
1. User navigates to card details page
2. Frontend calls `GET /api/cards/[cardCode]`
3. Backend verifies user owns card (queries Supabase `cards` table)
4. Backend extracts `card_code` from Supabase record
5. Backend calls this API (`/CustomerCard/getCard`) with `card_code`
6. Cashwyre returns complete, real-time card data
7. Backend merges Supabase reference data with Cashwyre fresh data
8. Combined data returned to frontend

**Request Payload:**
```json
{
  "appId": "<CASHWYRE_APP_ID>",
  "businessCode": "<CASHWYRE_BUSINESS_CODE>",
  "requestId": "KARDSC3D4E5F6G7H8",
  "cardCode": "CARD123456789"
}
```

**Field Descriptions:**
- `cardCode` (required): The card code from Supabase `cards.card_code` column
- This code was set by the `virtualcard.created.success` webhook

**Response:**
```json
{
  "success": true,
  "data": {
    "cardCode": "CARD123456789",
    "customerCode": "CUST123456789",
    "balance": 150.75,
    "last4": "1234",
    "expiryOn": "12/2025",
    "status": "active",
    "cardName": "My Personal Card",
    "currency": "USD",
    "cardType": "physical",
    "cardBrand": "visa",
    "transactions": [
      {
        "id": "txn123",
        "amount": -50.00,
        "description": "Purchase at Amazon",
        "merchant": "Amazon",
        "date": "2024-01-15T14:30:00Z",
        "type": "debit",
        "status": "completed"
      },
      {
        "id": "txn124",
        "amount": 100.00,
        "description": "Top-up",
        "date": "2024-01-15T10:00:00Z",
        "type": "credit",
        "status": "completed"
      }
    ],
    "metadata": {
      "issuer": "Cashwyre",
      "cardNetwork": "Visa",
      ...
    }
  }
}
```

**Response Fields:**
- `cardCode` (string): Unique card identifier
- `customerCode` (string): Customer identifier in Cashwyre system
- `balance` (number): Current card balance in USD (real-time, accurate)
- `last4` (string): Last 4 digits of card number
- `expiryOn` (string): Card expiry date in format "MM/YYYY"
- `status` (string): Card status ("active", "frozen", "cancelled")
- `cardName` (string): User-defined card name
- `currency` (string): Currency code (always "USD")
- `cardType` (string): Card type (always "physical")
- `cardBrand` (string): Card brand (always "visa")
- `transactions` (array): Complete transaction history with details
- `metadata` (object): Additional card metadata

**Transaction Object Structure:**
```json
{
  "id": "txn123",
  "amount": -50.00,           // Negative for debits, positive for credits
  "description": "Purchase at Amazon",
  "merchant": "Amazon",       // Merchant name (if applicable)
  "date": "2024-01-15T14:30:00Z",  // ISO 8601 timestamp
  "type": "debit",            // "debit" or "credit"
  "status": "completed"       // Transaction status
}
```

**Data Source:**
- **ALL data comes from Cashwyre API** - never from Supabase
- Supabase only stores `card_code` reference used to call this API
- Balance, transactions, expiry are always fetched fresh
- No caching - every request gets latest data from Cashwyre

**Important Notes:**
- This is the ONLY source of truth for card financial data
- Supabase `cards.balance` may be stale (updated from webhooks, but not reliable)
- Always use data from this API for display, never from Supabase cache
- Response time: ~2-4 seconds
- Called every time card details are requested (no caching)

**Error Handling:**
- If API call fails, error is returned to user
- Card reference remains in Supabase but details unavailable
- User sees error message, can retry

---

### 4. POST /CustomerCard/getCardTransactions

**Purpose:** Retrieves complete transaction history for a specific card. This endpoint provides all card purchase transactions, top-ups, and card activity.

**When Called:**
- When user views card transaction history (`GET /api/cards/[cardCode]/transactions`)
- Called on-demand when transaction list is requested
- Called after ownership verification
- Data is fetched fresh every time - never uses cached data

**Call Sequence:**
1. User navigates to card transactions page
2. Frontend calls `GET /api/cards/[cardCode]/transactions`
3. Backend verifies user owns card
4. Backend extracts `card_code` from Supabase
5. Backend calls this API (`/CustomerCard/getCardTransactions`)
6. Cashwyre returns transaction list
7. Transactions returned to frontend

**Request Payload:**
```json
{
  "appId": "<CASHWYRE_APP_ID>",
  "businessCode": "<CASHWYRE_BUSINESS_CODE>",
  "requestId": "KARDSD4E5F6G7H8I9",
  "cardCode": "CARD123456789"
}
```

**Field Descriptions:**
- `cardCode` (required): The card code from Supabase `cards.card_code` column

**Response:**
```json
{
  "success": true,
  "CardTransactions": [
    {
      "id": "txn123456",
      "cardCode": "CARD123456789",
      "amount": -50.00,
      "description": "Purchase at Amazon",
      "merchant": "Amazon",
      "merchantCategory": "E-commerce",
      "date": "2024-01-15T14:30:00Z",
      "type": "debit",
      "status": "completed",
      "currency": "USD",
      "location": {
        "city": "New York",
        "country": "USA"
      }
    },
    {
      "id": "txn123455",
      "cardCode": "CARD123456789",
      "amount": 100.00,
      "description": "Top-up",
      "date": "2024-01-15T10:00:00Z",
      "type": "credit",
      "status": "completed",
      "currency": "USD"
    },
    {
      "id": "txn123454",
      "cardCode": "CARD123456789",
      "amount": -25.50,
      "description": "Restaurant Payment",
      "merchant": "Local Restaurant",
      "merchantCategory": "Food & Dining",
      "date": "2024-01-14T19:00:00Z",
      "type": "debit",
      "status": "completed",
      "currency": "USD",
      "location": {
        "city": "Los Angeles",
        "country": "USA"
      }
    }
  ]
}
```

**Response Fields:**
- `CardTransactions` (array): Array of transaction objects
- Each transaction includes:
  - `id` (string): Unique transaction identifier
  - `cardCode` (string): Card code this transaction belongs to
  - `amount` (number): Transaction amount (negative for debits, positive for credits)
  - `description` (string): Transaction description
  - `merchant` (string, optional): Merchant name for purchases
  - `merchantCategory` (string, optional): Category of merchant
  - `date` (string): ISO 8601 timestamp
  - `type` (string): "debit" or "credit"
  - `status` (string): Transaction status ("completed", "pending", "failed")
  - `currency` (string): Currency code (always "USD")
  - `location` (object, optional): Transaction location (city, country)

**Data Source:**
- **ALL transactions come from Cashwyre API** - never from Supabase
- Supabase `transactions` table does NOT store card purchase transactions
- Only reference records for bridge/insurance/top-up operations are in Supabase
- Card transactions are always fetched fresh from Cashwyre

**Transaction Types:**
- **Debit transactions:** Card purchases, ATM withdrawals, fees
- **Credit transactions:** Top-ups, refunds, adjustments
- All transactions are real-time from Cashwyre system

**Important Notes:**
- This is the ONLY source of truth for card transaction history
- Transactions are sorted by date (newest first typically)
- No pagination currently - returns all transactions
- Response time: ~2-4 seconds
- Called every time transaction list is requested (no caching)

**Error Handling:**
- If API call fails, empty array or error returned
- User sees error message, can retry

---

### 5. POST /CustomerCard/topup

**Purpose:** Adds funds to an existing card. This is called automatically after Cashwyre detects a payment to the card's Ethereum address.

**When Called:**
- **NOT called directly by user** - called automatically by webhook handler
- Triggered by payment webhook: `stablecoin.usdc.received.success`
- Called in `/api/webhooks/cashwyre-payment` webhook handler
- Only called when:
  1. Payment webhook is received
  2. Card already exists (`card_code` is not null)
  3. Payment amount matches expected top-up amount

**Call Sequence (Complete Top-up Flow):**
1. User initiates top-up via `POST /api/cards/[cardCode]/topup`
2. User's funds are bridged from Flare ‚Üí Ethereum network (takes 5-15 minutes)
3. Funds arrive at card's `card_wallet_address` (Ethereum address)
4. Cashwyre detects payment on Ethereum network (usually 1-5 minutes after arrival)
5. Cashwyre sends webhook: `POST /api/webhooks/cashwyre-payment` with event `stablecoin.usdc.received.success`
6. Webhook handler finds card by `card_wallet_address`
7. Webhook handler calculates top-up amount (original amount minus $2.50 processing fee)
8. Webhook handler calls this API (`/CustomerCard/topup`) with calculated amount
9. Cashwyre processes top-up (adds funds to card)
10. Card balance updated in Supabase (cached, but should fetch from API for accuracy)

**Request Payload:**
```json
{
  "appId": "<CASHWYRE_APP_ID>",
  "businessCode": "<CASHWYRE_BUSINESS_CODE>",
  "requestId": "KARDSE5F6G7H8I9J0",
  "cardCode": "CARD123456789",
  "amountInUSD": 47.50
}
```

**Field Descriptions:**
- `cardCode` (required): The card code from Supabase `cards.card_code` column
- `amountInUSD` (required): Amount to add to card in USD (this is the amount AFTER processing fee deduction)

**Processing Fee Calculation:**
- User sends: $50.00 (original amount)
- Processing fee: $2.50 (fixed fee)
- Amount sent to Cashwyre: $47.50 (calculated by `calculateTopUpAmount(50) = 50 - 2.50`)
- Formula: `topUpAmount = originalAmount - 2.50`

**Response:**
```json
{
  "success": true,
  "message": "Top-up processed successfully",
  "data": {
    "cardCode": "CARD123456789",
    "newBalance": 197.50,
    "amountAdded": 47.50
  }
}
```

**Response Fields:**
- `cardCode` (string): Card code that was topped up
- `newBalance` (number): New card balance after top-up
- `amountAdded` (number): Amount that was added to card

**Important Notes:**
- Processing fee ($2.50) is deducted BEFORE calling this API
- If user sends $50, card receives $47.50 (after $2.50 fee)
- Fee is handled internally - Cashwyre receives net amount
- Top-up is processed synchronously (usually completes within seconds)
- Card balance in Supabase is updated but may be stale - always fetch from `/CustomerCard/getCard` for accuracy

**Error Handling:**
- If API call fails, webhook logs error
- Transaction status remains "pending" in Supabase
- Webhook can be manually reprocessed
- User's funds are safe (already on Ethereum, just need to retry top-up API call)

**Timing:**
- Called automatically by webhook handler (not user-initiated)
- Response time: ~3-5 seconds
- Total time from top-up request to completion: 10-25 minutes (bridge + webhook processing)

---

### 6. POST /Customer/freezeCard

**Purpose:** Freezes a card, preventing all transactions. Card cannot be used for purchases until unfrozen.

**When Called:**
- When user clicks "Freeze" button on card details page
- Called via `POST /api/cards/[cardCode]/freeze` endpoint
- Called immediately when user initiates freeze action
- Synchronous operation - card is frozen immediately

**Call Sequence:**
1. User clicks "Freeze Card" button
2. Frontend calls `POST /api/cards/[cardCode]/freeze`
3. Backend verifies user owns card
4. Backend calls this API (`/Customer/freezeCard`)
5. Cashwyre freezes card immediately
6. Backend updates card status to "frozen" in Supabase
7. Success response returned to user

**Request Payload:**
```json
{
  "appId": "<CASHWYRE_APP_ID>",
  "businessCode": "<CASHWYRE_BUSINESS_CODE>",
  "requestId": "KARDSF6G7H8I9J0K1",
  "cardCode": "CARD123456789"
}
```

**Field Descriptions:**
- `cardCode` (required): The card code from Supabase `cards.card_code` column

**Response:**
```json
{
  "success": true,
  "message": "Card frozen successfully",
  "data": {
    "cardCode": "CARD123456789",
    "status": "frozen"
  }
}
```

**Response Fields:**
- `cardCode` (string): Card code that was frozen
- `status` (string): New card status ("frozen")

**Important Notes:**
- Card is frozen immediately (synchronous operation)
- All transactions are blocked while frozen
- Card can be unfrozen using `/Customer/unfreezeCard` API
- Status updated in both Cashwyre and Supabase
- Response time: ~2-3 seconds

**Error Handling:**
- If API call fails, error returned to user
- Card status in Supabase remains unchanged
- User can retry freeze operation

---

### 7. POST /Customer/unfreezeCard

**Purpose:** Unfreezes a previously frozen card, allowing transactions to resume.

**When Called:**
- When user clicks "Unfreeze" button on card details page
- Called via `POST /api/cards/[cardCode]/unfreeze` endpoint
- Called immediately when user initiates unfreeze action
- Synchronous operation - card is unfrozen immediately

**Call Sequence:**
1. User clicks "Unfreeze Card" button (shown when card status is "frozen")
2. Frontend calls `POST /api/cards/[cardCode]/unfreeze`
3. Backend verifies user owns card
4. Backend calls this API (`/Customer/unfreezeCard`)
5. Cashwyre unfreezes card immediately
6. Backend updates card status to "active" in Supabase
7. Success response returned to user

**Request Payload:**
```json
{
  "appId": "<CASHWYRE_APP_ID>",
  "businessCode": "<CASHWYRE_BUSINESS_CODE>",
  "requestId": "KARDSG7H8I9J0K1L2",
  "cardCode": "CARD123456789"
}
```

**Field Descriptions:**
- `cardCode` (required): The card code from Supabase `cards.card_code` column

**Response:**
```json
{
  "success": true,
  "message": "Card unfrozen successfully",
  "data": {
    "cardCode": "CARD123456789",
    "status": "active"
  }
}
```

**Response Fields:**
- `cardCode` (string): Card code that was unfrozen
- `status` (string): New card status ("active")

**Important Notes:**
- Card is unfrozen immediately (synchronous operation)
- Transactions can resume immediately after unfreeze
- Status updated in both Cashwyre and Supabase
- Response time: ~2-3 seconds

**Error Handling:**
- If API call fails, error returned to user
- Card status in Supabase remains "frozen"
- User can retry unfreeze operation

---

## üîî Cashwyre Webhooks

Webhooks are HTTP POST requests sent by Cashwyre to your server when specific events occur. The system uses an asynchronous webhook-based architecture where operations complete via webhooks rather than direct API responses.

### Webhook Configuration

**Setup Required:**
1. Configure webhook URLs in Cashwyre dashboard
2. URLs must point to your Vercel deployment (e.g., `https://your-app.vercel.app/api/webhooks/...`)
3. Webhooks must be publicly accessible (no localhost)
4. Cashwyre will send POST requests to these URLs when events occur

**Security:**
- ‚ö†Ô∏è **Webhook signature validation is NOT currently implemented** - security risk
- Should implement signature verification to ensure webhooks come from Cashwyre
- All webhooks are logged to `webhook_logs` table for audit trail

**Retry Logic:**
- Cashwyre automatically retries failed webhooks
- Retries continue until webhook returns 200 status code
- Failed webhooks are logged with error messages

---

### Webhook 1: Payment Received (stablecoin.usdc.received.success)

**Endpoint:** `POST /api/webhooks/cashwyre-payment`

**Event Types Handled:**
- `stablecoin.usdc.received.success` - USDC payment received
- `stablecoin.usdt.received.success` - USDT payment received (same handling)

**When Triggered:**
- Cashwyre detects USDC/USDT payment to an Ethereum address they're monitoring
- Usually triggered 1-5 minutes after funds arrive on Ethereum network
- Triggered automatically - no manual action required
- Asynchronous event - happens in background

**Complete Trigger Flow:**
1. User initiates card creation or top-up
2. Funds are bridged from Flare ‚Üí Ethereum (takes 5-15 minutes)
3. Funds arrive at `card_wallet_address` on Ethereum network
4. Cashwyre monitors Ethereum addresses associated with cards
5. Cashwyre detects incoming payment (blockchain scanning)
6. Cashwyre sends webhook to `/api/webhooks/cashwyre-payment`
7. Webhook includes payment details (address, amount)

**Webhook Payload:**
```json
{
  "eventType": "stablecoin.usdc.received.success",
  "eventData": {
    "address": "0x742d35Cc6634C0532925a3b844Bc9e7595f0bEb",
    "amount": "50.00",
    "currency": "USDC",
    "network": "Ethereum",
    "transactionHash": "0xabc123...",
    "timestamp": "2024-01-15T10:30:00Z"
  }
}
```

**Payload Fields:**
- `eventType` (string): Event type identifier
- `eventData.address` (string): Ethereum address that received payment (this is `card_wallet_address`)
- `eventData.amount` (string): Payment amount in USD
- `eventData.currency` (string): Currency code ("USDC" or "USDT")
- `eventData.network` (string): Blockchain network ("Ethereum")
- `eventData.transactionHash` (string): Ethereum transaction hash
- `eventData.timestamp` (string): Payment timestamp

**Processing Logic:**

**Step 1: Log Webhook**
```javascript
await supabaseAdmin.from('webhook_logs').insert({
  event_type: eventType,
  event_data: body,  // Full webhook payload
  processed: false
});
```
- Webhook is logged immediately before processing
- Allows for audit trail and error recovery
- `processed` flag set to `false` initially

**Step 2: Find Card by Address**
```javascript
const { data: card } = await supabaseAdmin
  .from('cards')
  .select('*')
  .eq('card_wallet_address', address)  // Match Ethereum address
  .single();
```
- Finds card record using the Ethereum address from webhook
- Each card has unique `card_wallet_address` for payment tracking

**Step 3: Determine Operation Type**

**If Card Not Found OR Card Status is "processing" AND card_code is null:**
- This is a **card creation** payment
- Card was created but payment just arrived
- Proceed to card creation flow

**If Card Exists AND card_code is NOT null:**
- This is a **top-up** payment
- Card already exists, adding more funds
- Proceed to top-up flow

**Card Creation Flow (When Payment Received for New Card):**

1. **Find Pending Card:**
```javascript
const { data: pendingCard } = await supabaseAdmin
  .from('cards')
  .select('*')
  .eq('card_wallet_address', address)
  .eq('status', 'processing')
  .is('card_code', null)
  .order('created_at', { ascending: false })
  .limit(1)
  .single();
```
- Finds the pending card waiting for payment
- Card status is "processing" and `card_code` is null (not yet created)

2. **Get User Details:**
```javascript
const { data: user } = await supabaseAdmin
  .from('users')
  .select('id, first_name, last_name, email')
  .eq('id', pendingCard.user_id)
  .single();
```
- Retrieves user information needed for card creation API

3. **Extract Form Data:**
```javascript
const formData = pendingCard.form_data;
```
- Retrieves stored form data from `cards.form_data` JSONB column
- This includes: phoneCode, phoneNumber, dateOfBirth, homeAddressNumber, homeAddress, cardName, cardType, cardBrand, initialAmount
- This data was stored during initial card creation request

4. **Call Create Card API:**
```javascript
await callCashwyreAPI('/CustomerCard/createCard', {
  requestId: generateRequestId(),
  firstName: user.first_name,
  lastName: user.last_name,
  email: user.email,
  phoneCode: formData.phoneCode,        // Auto-generated
  phoneNumber: formData.phoneNumber,    // Auto-generated
  dateOfBirth: formData.dateOfBirth,    // Auto-generated
  homeAddressNumber: formData.homeAddressNumber,  // Auto-generated
  homeAddress: formData.homeAddress,    // Auto-generated
  cardName: formData.cardName,
  cardType: formData.cardType,          // Always "physical"
  cardBrand: formData.cardBrand,        // Always "visa"
  amountInUSD: formData.initialAmount   // User's initial funding amount
});
```
- Calls Cashwyre API to actually create the card
- Uses all stored form data (including auto-generated contact info)
- Cashwyre processes card creation (takes 1-5 minutes)
- Card code will come later via `virtualcard.created.success` webhook

5. **Mark Webhook as Processed:**
```javascript
await supabaseAdmin
  .from('webhook_logs')
  .update({ processed: true })
  .eq('event_type', eventType);
```
- Marks webhook as successfully processed
- Prevents duplicate processing

**Top-up Flow (When Payment Received for Existing Card):**

1. **Verify Card Exists:**
```javascript
if (!card.card_code) {
  return error; // Card code required for top-up
}
```
- Ensures card has been created (has `card_code`)
- Cannot top-up a card that doesn't exist yet

2. **Calculate Top-up Amount:**
```javascript
const topUpAmount = calculateTopUpAmount(parseFloat(amount));
// calculateTopUpAmount(50) = 47.50 (subtracts $2.50 processing fee)
```
- Deducts $2.50 processing fee from payment amount
- Formula: `amount - 2.50`
- Example: $50 payment ‚Üí $47.50 added to card

3. **Call Top-up API:**
```javascript
await callCashwyreAPI('/CustomerCard/topup', {
  requestId: generateRequestId(),
  cardCode: card.card_code,
  amountInUSD: topUpAmount  // Amount after fee deduction
});
```
- Calls Cashwyre API to add funds to card
- Uses `card_code` to identify which card to top up
- Amount is the net amount after processing fee

4. **Update Card Balance (Cached):**
```javascript
await supabaseAdmin
  .from('cards')
  .update({
    balance: (card.balance || 0) + topUpAmount
  })
  .eq('id', card.id);
```
- Updates cached balance in Supabase
- ‚ö†Ô∏è **Note:** This is cached data - always fetch from `/CustomerCard/getCard` for accuracy
- Balance may be stale if multiple operations occur

5. **Update Transaction Status:**
```javascript
await supabaseAdmin
  .from('transactions')
  .update({
    status: 'success',
    amount: topUpAmount
  })
  .eq('card_id', card.id)
  .eq('type', 'top_up')
  .eq('status', 'pending');
```
- Updates the reference transaction record
- Changes status from "pending" to "success"
- Records the actual amount added (after fee)

6. **Mark Webhook as Processed:**
```javascript
await supabaseAdmin
  .from('webhook_logs')
  .update({ processed: true })
  .eq('event_type', eventType);
```

**Error Handling:**
- If card not found: Logs error, marks webhook as processed with error message
- If API call fails: Logs error, `processed` remains `false`, webhook can be reprocessed
- If amount mismatch: Logs error, webhook marked with error message
- All errors logged in `webhook_logs.error_message` field

**Response:**
```json
{
  "success": true,
  "message": "Card creation initiated" // or "Top-up processed successfully"
}
```

**Timing:**
- Webhook arrives: 1-5 minutes after funds arrive on Ethereum
- Processing time: ~3-5 seconds (API calls)
- Total time from payment to processing: Usually under 10 minutes

---

### Webhook 2: Card Created (virtualcard.created.success)

**Endpoint:** `POST /api/webhooks/cashwyre-card-created`

**Event Type:** `virtualcard.created.success`

**When Triggered:**
- Cashwyre successfully creates a card after processing the `createCard` API call
- Usually triggered 1-5 minutes after `/CustomerCard/createCard` API is called
- Triggered automatically when card creation completes
- Asynchronous event - final step in card creation flow

**Complete Trigger Flow:**
1. Payment webhook received ‚Üí `/CustomerCard/createCard` API called
2. Cashwyre processes card creation (verification, card issuance, etc.)
3. Card is created in Cashwyre system (takes 1-5 minutes)
4. Cashwyre sends webhook to `/api/webhooks/cashwyre-card-created`
5. Webhook includes card details (cardCode, customerCode, balance, etc.)
6. System updates card reference in Supabase with `card_code`
7. Card status changes to "active" - card is ready to use

**Webhook Payload:**
```json
{
  "eventType": "virtualcard.created.success",
  "eventData": {
    "cardCode": "CARD123456789",
    "CustomerId": "CUST123456789",
    "CustomerEmail": "john@example.com",
    "CardBalance": 50.00,
    "Last4": "1234",
    "ExpiryOn": "12/2025",
    "CardName": "My Personal Card",
    "Status": "active",
    "CardType": "physical",
    "CardBrand": "visa",
    "Currency": "USD"
  }
}
```

**Payload Fields:**
- `eventType` (string): Always `"virtualcard.created.success"`
- `eventData.cardCode` (string): **CRITICAL** - Unique card identifier, stored as `card_code` in Supabase
- `eventData.CustomerId` (string): Customer code in Cashwyre system, stored as `customer_code`
- `eventData.CustomerEmail` (string): User's email address (used to find user)
- `eventData.CardBalance` (number): Initial card balance in USD
- `eventData.Last4` (string): Last 4 digits of card number
- `eventData.ExpiryOn` (string): Card expiry date (format: "MM/YYYY")
- `eventData.CardName` (string): User-defined card name
- `eventData.Status` (string): Card status ("active")
- `eventData.CardType` (string): Card type ("physical")
- `eventData.CardBrand` (string): Card brand ("visa")
- `eventData.Currency` (string): Currency code ("USD")

**Processing Logic:**

**Step 1: Log Webhook**
```javascript
await supabaseAdmin.from('webhook_logs').insert({
  event_type: eventType,
  event_data: body,  // Full webhook payload
  processed: false
});
```
- Webhook logged immediately for audit trail

**Step 2: Validate Required Fields**
```javascript
const { cardCode, CustomerEmail } = eventData;
if (!cardCode || !CustomerEmail) {
  return error; // Missing required fields
}
```
- Ensures `cardCode` and `CustomerEmail` are present
- These are required to find and update the card

**Step 3: Find User by Email**
```javascript
const { data: user } = await supabaseAdmin
  .from('users')
  .select('id, first_name, last_name, email, eth_deposit_address')
  .eq('email', CustomerEmail.toLowerCase())
  .single();
```
- Finds user record using email from webhook
- Email is case-insensitive (lowercased for comparison)
- If user not found, webhook is marked as processed with error message

**Step 4: Verify Card Limit**
```javascript
const { count } = await supabaseAdmin
  .from('cards')
  .select('*', { count: 'exact', head: true })
  .eq('user_id', user.id);

if (count && count >= 4) {
  return error; // User has reached 4 card limit
}
```
- Checks if user already has 4 cards (maximum allowed)
- Prevents exceeding card limit
- If limit reached, webhook processing fails

**Step 5: Find Pending Card**
```javascript
const { data: card } = await supabaseAdmin
  .from('cards')
  .select('*')
  .eq('user_id', user.id)
  .eq('status', 'processing')      // Card is still processing
  .is('card_code', null)            // Card code not yet set
  .order('created_at', { ascending: false })  // Most recent first
  .limit(1)
  .single();
```
- Finds the card that was just created
- Matches user, status "processing", and null `card_code`
- Orders by creation date to get most recent pending card
- If multiple pending cards exist, gets the newest one

**Step 6: Update Card Reference**
```javascript
await supabaseAdmin
  .from('cards')
  .update({
    card_code: cardCode,                    // CRITICAL: Used to fetch card details
    customer_code: eventData.CustomerId || null,
    status: 'active',                        // Card is now active
    balance: eventData.CardBalance || 0,     // Initial balance (may be stale)
    last4: eventData.Last4 || null,          // Last 4 digits (may be stale)
    expiry_on: eventData.ExpiryOn || null    // Expiry date (may be stale)
  })
  .eq('id', card.id);
```
- **Sets `card_code`** - This is the most important field, used to fetch card details from Cashwyre API
- Sets `customer_code` - Customer identifier in Cashwyre system
- Changes status from "processing" to "active" - Card is now ready to use
- Caches balance, last4, and expiry (but these may be stale - always fetch from API for accuracy)

**Step 7: Mark Webhook as Processed**
```javascript
await supabaseAdmin
  .from('webhook_logs')
  .update({ processed: true })
  .eq('event_type', eventType);
```
- Marks webhook as successfully processed
- Prevents duplicate processing

**Important Notes:**
- **`card_code` is CRITICAL** - Without it, card details cannot be fetched from Cashwyre API
- Card status changes from "processing" to "active" - user can now see and use card
- Balance, last4, expiry are cached but may be stale - always fetch from `/CustomerCard/getCard` for real-time data
- Card creation is now complete - full lifecycle: user request ‚Üí bridge ‚Üí payment webhook ‚Üí createCard API ‚Üí card created webhook ‚Üí active

**Error Handling:**
- If user not found: Webhook marked as processed with error message
- If card limit exceeded: Webhook fails, error logged
- If pending card not found: Webhook fails, error logged (should not happen if flow is correct)
- If update fails: Webhook marked with error, can be reprocessed

**Response:**
```json
{
  "success": true,
  "message": "Card created successfully"
}
```

**Timing:**
- Webhook arrives: 1-5 minutes after `/CustomerCard/createCard` API is called
- Processing time: ~1-2 seconds (database updates)
- Total time from card creation API to card active: 1-5 minutes

---

## ‚è±Ô∏è Complete API Call Timing & Sequence

### Card Creation: Complete Timeline with API Calls

**T+0 seconds: User Initiates Card Creation**
- User fills form: cardName, referralCode (optional), initialAmount
- Frontend calls: `POST /api/cards/create`

**T+0-2 seconds: Create Ethereum Address**
- **API Called:** `POST /CustomerCryptoAddress/createCryptoAddress`
- **When:** Immediately after validation
- **Response Time:** ~2-3 seconds
- **Returns:** Ethereum address (`0x742d35Cc6634C0532925a3b844Bc9e7595f0bEb`)
- **Stored As:** `card_wallet_address` in `cards` table

**T+2-25 seconds: Bridge Transaction Submission**
- Insurance fee sent ($10 USDC to insurance wallet)
- Bridge transaction submitted (Flare ‚Üí Ethereum)
- Card record created in Supabase with status "processing"
- Response returned to user: "Card creation initiated. Processing..."

**T+5-15 minutes: Bridge Completes**
- User's USDC bridged from Flare ‚Üí Ethereum network
- Funds arrive at `card_wallet_address` on Ethereum
- **No API calls during this time** - external blockchain process

**T+6-20 minutes: Payment Webhook Received**
- **Webhook:** `POST /api/webhooks/cashwyre-payment`
- **Event:** `stablecoin.usdc.received.success`
- **When:** Cashwyre detects payment (1-5 minutes after funds arrive)
- **Process:**
  1. Webhook logged to `webhook_logs`
  2. Card found by `card_wallet_address`
  3. **API Called:** `POST /CustomerCard/createCard`
  4. Card creation initiated on Cashwyre side
  5. Webhook marked as processed

**T+7-25 minutes: Card Created Webhook Received**
- **Webhook:** `POST /api/webhooks/cashwyre-card-created`
- **Event:** `virtualcard.created.success`
- **When:** Cashwyre finishes creating card (1-5 minutes after createCard API)
- **Process:**
  1. Webhook logged to `webhook_logs`
  2. User found by email
  3. Pending card found (status="processing", card_code=null)
  4. Card updated with `card_code`, status="active"
  5. Webhook marked as processed

**T+25 minutes: Card is Active**
- Card status: "active"
- `card_code` is set
- Card can be viewed and used
- Card details can be fetched via `POST /CustomerCard/getCard`

---

### Top-up: Complete Timeline with API Calls

**T+0 seconds: User Initiates Top-up**
- User enters amount (minimum $6)
- Frontend calls: `POST /api/cards/[cardCode]/topup`

**T+0-15 seconds: Bridge Transaction Submission**
- Balance checks (USDC and XRD)
- Bridge quote obtained
- Bridge transaction submitted (Flare ‚Üí Ethereum)
- Transaction record created with status "pending"
- Response returned to user: "Top-up initiated. Processing..."

**T+5-15 minutes: Bridge Completes**
- User's USDC bridged from Flare ‚Üí Ethereum network
- Funds arrive at card's `card_wallet_address` on Ethereum
- **No API calls during this time** - external blockchain process

**T+6-20 minutes: Payment Webhook Received**
- **Webhook:** `POST /api/webhooks/cashwyre-payment`
- **Event:** `stablecoin.usdc.received.success`
- **When:** Cashwyre detects payment (1-5 minutes after funds arrive)
- **Process:**
  1. Webhook logged to `webhook_logs`
  2. Card found by `card_wallet_address`
  3. Top-up amount calculated (original amount - $2.50 fee)
  4. **API Called:** `POST /CustomerCard/topup`
  5. Funds added to card
  6. Card balance updated in Supabase (cached)
  7. Transaction status updated to "success"
  8. Webhook marked as processed

**T+20 minutes: Top-up Complete**
- Card balance increased by net amount (after fee)
- Transaction status: "success"
- User can see updated balance (fetch from API for accuracy)

---

## üìã Summary: When Each API is Called

### Direct User-Initiated API Calls:

1. **`POST /CustomerCryptoAddress/createCryptoAddress`**
   - **When:** During card creation (`POST /api/cards/create`)
   - **Frequency:** Once per card (or reused if previous card creation cancelled)
   - **Response Time:** ~2-3 seconds
   - **Synchronous:** Yes (waits for response)

2. **`POST /CustomerCard/getCard`**
   - **When:** Every time user views card details (`GET /api/cards/[cardCode]`)
   - **Frequency:** On-demand, every page load
   - **Response Time:** ~2-4 seconds
   - **Synchronous:** Yes (waits for response)
   - **Caching:** None - always fetches fresh data

3. **`POST /CustomerCard/getCardTransactions`**
   - **When:** Every time user views card transactions (`GET /api/cards/[cardCode]/transactions`)
   - **Frequency:** On-demand, every page load
   - **Response Time:** ~2-4 seconds
   - **Synchronous:** Yes (waits for response)
   - **Caching:** None - always fetches fresh data

4. **`POST /Customer/freezeCard`**
   - **When:** User clicks "Freeze" button (`POST /api/cards/[cardCode]/freeze`)
   - **Frequency:** On-demand, user action
   - **Response Time:** ~2-3 seconds
   - **Synchronous:** Yes (immediate freeze)

5. **`POST /Customer/unfreezeCard`**
   - **When:** User clicks "Unfreeze" button (`POST /api/cards/[cardCode]/unfreeze`)
   - **Frequency:** On-demand, user action
   - **Response Time:** ~2-3 seconds
   - **Synchronous:** Yes (immediate unfreeze)

### Webhook-Triggered API Calls (Automatic):

6. **`POST /CustomerCard/createCard`**
   - **When:** Automatically by payment webhook handler
   - **Trigger:** `stablecoin.usdc.received.success` webhook for card creation
   - **Frequency:** Once per card creation (after payment received)
   - **Response Time:** ~3-5 seconds
   - **Synchronous:** Yes (webhook handler waits)
   - **Timing:** 6-20 minutes after user initiates card creation

7. **`POST /CustomerCard/topup`**
   - **When:** Automatically by payment webhook handler
   - **Trigger:** `stablecoin.usdc.received.success` webhook for top-up
   - **Frequency:** Once per top-up (after payment received)
   - **Response Time:** ~3-5 seconds
   - **Synchronous:** Yes (webhook handler waits)
   - **Timing:** 6-20 minutes after user initiates top-up

---

## üîÑ Webhook Flow Diagrams

### Card Creation Webhook Flow:

```
User Request (POST /api/cards/create)
    ‚Üì
Create Ethereum Address (POST /CustomerCryptoAddress/createCryptoAddress)
    ‚Üì
Submit Bridge Transaction (Flare Network)
    ‚Üì
[Wait 5-15 minutes for bridge to complete]
    ‚Üì
Funds Arrive at Ethereum Address
    ‚Üì
[Wait 1-5 minutes for Cashwyre to detect]
    ‚Üì
Payment Webhook Received (POST /api/webhooks/cashwyre-payment)
    Event: stablecoin.usdc.received.success
    ‚Üì
Call Create Card API (POST /CustomerCard/createCard)
    ‚Üì
[Wait 1-5 minutes for Cashwyre to create card]
    ‚Üì
Card Created Webhook Received (POST /api/webhooks/cashwyre-card-created)
    Event: virtualcard.created.success
    ‚Üì
Update Card with card_code
    Status: "active"
    ‚Üì
Card Ready to Use
```

### Top-up Webhook Flow:

```
User Request (POST /api/cards/[cardCode]/topup)
    ‚Üì
Submit Bridge Transaction (Flare Network)
    ‚Üì
[Wait 5-15 minutes for bridge to complete]
    ‚Üì
Funds Arrive at Card's Ethereum Address
    ‚Üì
[Wait 1-5 minutes for Cashwyre to detect]
    ‚Üì
Payment Webhook Received (POST /api/webhooks/cashwyre-payment)
    Event: stablecoin.usdc.received.success
    ‚Üì
Calculate Top-up Amount (amount - $2.50 fee)
    ‚Üì
Call Top-up API (POST /CustomerCard/topup)
    ‚Üì
Update Card Balance (cached)
    Update Transaction Status: "success"
    ‚Üì
Top-up Complete
```

---

## üéØ Key Points Summary

**Request ID Format:**
- Always starts with "KARDS"
- Followed by 12 alphanumeric characters (A-Z, 0-9)
- Example: `KARDSA1B2C3D4E5F6`
- No dashes, underscores, or special characters
- Generated by `generateRequestId()` function

**Auto-Generated Data:**
- Phone code: Randomly selected from worldwide country codes
- Phone number: Randomly generated, valid format for selected country
- Date of birth: Random date (25-65 years old)
- Address: Randomly generated based on country code
- **NOT stored in Supabase** - only sent to Cashwyre API once
- **User never sees this data** - completely transparent

**Hardcoded Values:**
- Card type: Always `"physical"` (never virtual)
- Card brand: Always `"visa"` (never Mastercard or other)
- These are set automatically, user cannot choose

**Data Storage:**
- Card transactions: **NEVER stored** - always fetched from Cashwyre API
- Card details: **NEVER stored** - always fetched from Cashwyre API
- Only `card_code` reference stored in Supabase
- All financial data fetched fresh every time

**Webhook Reliability:**
- All webhooks logged to `webhook_logs` table before processing
- Failed webhooks can be manually reprocessed
- `processed` flag tracks webhook status
- Error messages stored in `error_message` field

**Timing Summary:**
- Card creation: 15-30 minutes total (mostly waiting for webhooks)
- Top-up: 10-25 minutes total (mostly waiting for webhooks)
- API response times: 2-5 seconds each
- Webhook processing: 3-5 seconds each
- Most time is spent waiting for blockchain and Cashwyre processing

---

---

## üìù Detailed API Request/Response Examples

### Example 1: Complete Card Creation API Call Chain

**Step 1: Create Ethereum Address**
```javascript
// Request
POST https://businessapi.cashwyre.com/api/v1.0/CustomerCryptoAddress/createCryptoAddress
Headers: {
  "Content-Type": "application/json",
  "Authorization": "Bearer CASHWYRE_SECRET_KEY"
}
Body: {
  "appId": "APP123456",
  "businessCode": "BIZ789",
  "requestId": "KARDSABCD123456EF",
  "FirstName": "John",
  "LastName": "Doe",
  "Email": "john@example.com",
  "AssetType": "ETH",
  "Network": "USDC",
  "Amount": 0.0001
}

// Response (Success)
{
  "success": true,
  "message": "Address created successfully",
  "data": {
    "address": "0x742d35Cc6634C0532925a3b844Bc9e7595f0bEb"
  }
}

// Response (Error)
{
  "success": false,
  "error": "Invalid email format",
  "code": "VALIDATION_ERROR"
}
```

**Step 2: Create Card (via Webhook)**
```javascript
// Request (Called by webhook handler)
POST https://businessapi.cashwyre.com/api/v1.0/CustomerCard/createCard
Headers: {
  "Content-Type": "application/json",
  "Authorization": "Bearer CASHWYRE_SECRET_KEY"
}
Body: {
  "appId": "APP123456",
  "businessCode": "BIZ789",
  "requestId": "KARDSBCDE234567FG",
  "firstName": "John",
  "lastName": "Doe",
  "email": "john@example.com",
  "phoneCode": "+1",
  "phoneNumber": "5551234567",
  "dateOfBirth": "1990-05-15",
  "homeAddressNumber": "123",
  "homeAddress": "Main Street, New York, NY 10001, USA",
  "cardName": "My Personal Card",
  "cardType": "physical",
  "cardBrand": "visa",
  "amountInUSD": 50
}

// Response (Success)
{
  "success": true,
  "message": "Card creation initiated",
  "data": {
    "cardCode": null  // Will be provided via webhook
  }
}

// Response (Error - Insufficient Funds)
{
  "success": false,
  "error": "Insufficient funds in wallet",
  "code": "INSUFFICIENT_FUNDS"
}

// Response (Error - Invalid Data)
{
  "success": false,
  "error": "Invalid date of birth format",
  "code": "VALIDATION_ERROR"
}
```

---

### Example 2: Get Card Details API Call

**Request:**
```javascript
POST https://businessapi.cashwyre.com/api/v1.0/CustomerCard/getCard
Headers: {
  "Content-Type": "application/json",
  "Authorization": "Bearer CASHWYRE_SECRET_KEY"
}
Body: {
  "appId": "APP123456",
  "businessCode": "BIZ789",
  "requestId": "KARDSCDEF345678GH",
  "cardCode": "CARD123456789"
}
```

**Response (Success - Active Card):**
```json
{
  "success": true,
  "data": {
    "cardCode": "CARD123456789",
    "customerCode": "CUST987654321",
    "balance": 150.75,
    "last4": "1234",
    "expiryOn": "12/2025",
    "status": "active",
    "cardName": "My Personal Card",
    "currency": "USD",
    "cardType": "physical",
    "cardBrand": "visa",
    "createdAt": "2024-01-15T10:30:00Z",
    "updatedAt": "2024-01-15T14:30:00Z",
    "transactions": [
      {
        "id": "txn789012",
        "amount": -50.00,
        "description": "Purchase at Amazon",
        "merchant": "Amazon",
        "merchantCategory": "E-commerce",
        "date": "2024-01-15T14:30:00Z",
        "type": "debit",
        "status": "completed",
        "currency": "USD",
        "location": {
          "city": "New York",
          "state": "NY",
          "country": "USA"
        }
      },
      {
        "id": "txn789011",
        "amount": 100.00,
        "description": "Top-up",
        "date": "2024-01-15T10:00:00Z",
        "type": "credit",
        "status": "completed",
        "currency": "USD"
      }
    ],
    "metadata": {
      "issuer": "Cashwyre",
      "cardNetwork": "Visa",
      "cardProgram": "Standard",
      "activationDate": "2024-01-15T10:35:00Z"
    }
  }
}
```

**Response (Error - Card Not Found):**
```json
{
  "success": false,
  "error": "Card not found",
  "code": "CARD_NOT_FOUND",
  "message": "The specified card code does not exist or has been cancelled"
}
```

**Response (Error - Invalid Card Code):**
```json
{
  "success": false,
  "error": "Invalid card code format",
  "code": "VALIDATION_ERROR",
  "message": "Card code must be a valid alphanumeric string"
}
```

---

### Example 3: Get Card Transactions API Call

**Request:**
```javascript
POST https://businessapi.cashwyre.com/api/v1.0/CustomerCard/getCardTransactions
Headers: {
  "Content-Type": "application/json",
  "Authorization": "Bearer CASHWYRE_SECRET_KEY"
}
Body: {
  "appId": "APP123456",
  "businessCode": "BIZ789",
  "requestId": "KARDSDEFG456789HI",
  "cardCode": "CARD123456789"
}
```

**Response (Success):**
```json
{
  "success": true,
  "CardTransactions": [
    {
      "id": "txn001234",
      "cardCode": "CARD123456789",
      "amount": -75.50,
      "description": "Restaurant Payment - Fine Dining",
      "merchant": "The Gourmet Restaurant",
      "merchantCategory": "Food & Dining",
      "date": "2024-01-20T19:45:00Z",
      "type": "debit",
      "status": "completed",
      "currency": "USD",
      "location": {
        "city": "Los Angeles",
        "state": "CA",
        "country": "USA",
        "merchantAddress": "123 Restaurant St, Los Angeles, CA 90001"
      },
      "authorizationCode": "AUTH123456",
      "referenceNumber": "REF789012"
    },
    {
      "id": "txn001233",
      "cardCode": "CARD123456789",
      "amount": -25.00,
      "description": "Gas Station Purchase",
      "merchant": "Shell Gas Station",
      "merchantCategory": "Gas & Fuel",
      "date": "2024-01-20T14:20:00Z",
      "type": "debit",
      "status": "completed",
      "currency": "USD",
      "location": {
        "city": "San Francisco",
        "state": "CA",
        "country": "USA"
      }
    },
    {
      "id": "txn001232",
      "cardCode": "CARD123456789",
      "amount": 100.00,
      "description": "Top-up via Bridge",
      "date": "2024-01-18T10:00:00Z",
      "type": "credit",
      "status": "completed",
      "currency": "USD",
      "source": "bridge_transfer"
    },
    {
      "id": "txn001231",
      "cardCode": "CARD123456789",
      "amount": -150.00,
      "description": "Online Purchase - Electronics Store",
      "merchant": "TechMart Online",
      "merchantCategory": "Electronics",
      "date": "2024-01-17T16:30:00Z",
      "type": "debit",
      "status": "completed",
      "currency": "USD",
      "onlineTransaction": true
    },
    {
      "id": "txn001230",
      "cardCode": "CARD123456789",
      "amount": 50.00,
      "description": "Initial Card Funding",
      "date": "2024-01-15T10:35:00Z",
      "type": "credit",
      "status": "completed",
      "currency": "USD",
      "source": "card_creation"
    }
  ],
  "pagination": {
    "total": 5,
    "page": 1,
    "pageSize": 50
  }
}
```

**Transaction Object Detailed Fields:**
- `id` (string): Unique transaction identifier from Cashwyre system
- `cardCode` (string): Card code this transaction belongs to
- `amount` (number): Transaction amount - negative for debits (purchases), positive for credits (top-ups, refunds)
- `description` (string): Human-readable transaction description
- `merchant` (string, optional): Merchant name for purchase transactions
- `merchantCategory` (string, optional): Category code (e.g., "Food & Dining", "E-commerce", "Gas & Fuel")
- `date` (string): ISO 8601 timestamp of transaction
- `type` (string): Transaction type - "debit" (purchase) or "credit" (top-up, refund)
- `status` (string): Transaction status - "completed", "pending", "failed", "refunded"
- `currency` (string): Currency code (always "USD")
- `location` (object, optional): Transaction location information (city, state, country, address)
- `authorizationCode` (string, optional): Authorization code for card transactions
- `referenceNumber` (string, optional): Reference number for transaction
- `onlineTransaction` (boolean, optional): Whether transaction was online/offline
- `source` (string, optional): Source of credit transaction ("bridge_transfer", "card_creation", "refund")

**Response (Error):**
```json
{
  "success": false,
  "error": "Card not found",
  "code": "CARD_NOT_FOUND"
}
```

---

### Example 4: Top-up API Call (via Webhook)

**Request:**
```javascript
POST https://businessapi.cashwyre.com/api/v1.0/CustomerCard/topup
Headers: {
  "Content-Type": "application/json",
  "Authorization": "Bearer CASHWYRE_SECRET_KEY"
}
Body: {
  "appId": "APP123456",
  "businessCode": "BIZ789",
  "requestId": "KARDSEFGH567890IJ",
  "cardCode": "CARD123456789",
  "amountInUSD": 47.50
}
```

**Response (Success):**
```json
{
  "success": true,
  "message": "Top-up processed successfully",
  "data": {
    "cardCode": "CARD123456789",
    "previousBalance": 100.00,
    "amountAdded": 47.50,
    "newBalance": 147.50,
    "processingFee": 2.50,
    "transactionId": "topup_789012",
    "processedAt": "2024-01-20T15:30:00Z"
  }
}
```

**Response Fields Explained:**
- `previousBalance`: Card balance before top-up
- `amountAdded`: Net amount added to card (after processing fee)
- `newBalance`: Card balance after top-up
- `processingFee`: Fee deducted (always $2.50)
- `transactionId`: Cashwyre's internal transaction identifier
- `processedAt`: Timestamp when top-up was processed

**Response (Error - Insufficient Funds):**
```json
{
  "success": false,
  "error": "Insufficient funds in source wallet",
  "code": "INSUFFICIENT_FUNDS",
  "message": "The payment source does not have sufficient funds for this top-up"
}
```

**Response (Error - Card Frozen):**
```json
{
  "success": false,
  "error": "Card is frozen",
  "code": "CARD_FROZEN",
  "message": "Cannot top-up a frozen card. Please unfreeze the card first."
}
```

---

### Example 5: Freeze Card API Call

**Request:**
```javascript
POST https://businessapi.cashwyre.com/api/v1.0/Customer/freezeCard
Headers: {
  "Content-Type": "application/json",
  "Authorization": "Bearer CASHWYRE_SECRET_KEY"
}
Body: {
  "appId": "APP123456",
  "businessCode": "BIZ789",
  "requestId": "KARDSFGHI678901JK",
  "cardCode": "CARD123456789"
}
```

**Response (Success):**
```json
{
  "success": true,
  "message": "Card frozen successfully",
  "data": {
    "cardCode": "CARD123456789",
    "previousStatus": "active",
    "newStatus": "frozen",
    "frozenAt": "2024-01-20T16:00:00Z",
    "reason": "User requested"
  }
}
```

**Response (Error - Already Frozen):**
```json
{
  "success": false,
  "error": "Card is already frozen",
  "code": "ALREADY_FROZEN",
  "message": "This card is already in frozen state"
}
```

**Response (Error - Card Not Found):**
```json
{
  "success": false,
  "error": "Card not found",
  "code": "CARD_NOT_FOUND"
}
```

---

### Example 6: Unfreeze Card API Call

**Request:**
```javascript
POST https://businessapi.cashwyre.com/api/v1.0/Customer/unfreezeCard
Headers: {
  "Content-Type": "application/json",
  "Authorization": "Bearer CASHWYRE_SECRET_KEY"
}
Body: {
  "appId": "APP123456",
  "businessCode": "BIZ789",
  "requestId": "KARDSGHIJ789012KL",
  "cardCode": "CARD123456789"
}
```

**Response (Success):**
```json
{
  "success": true,
  "message": "Card unfrozen successfully",
  "data": {
    "cardCode": "CARD123456789",
    "previousStatus": "frozen",
    "newStatus": "active",
    "unfrozenAt": "2024-01-20T16:15:00Z"
  }
}
```

**Response (Error - Already Active):**
```json
{
  "success": false,
  "error": "Card is not frozen",
  "code": "NOT_FROZEN",
  "message": "This card is already in active state"
}
```

---

## üîî Detailed Webhook Payload Examples

### Webhook Example 1: Payment Received (Card Creation)

**Webhook URL:** `https://your-app.vercel.app/api/webhooks/cashwyre-payment`

**HTTP Method:** POST

**Headers:**
```
Content-Type: application/json
User-Agent: Cashwyre-Webhook/1.0
```

**Full Payload:**
```json
{
  "eventType": "stablecoin.usdc.received.success",
  "eventId": "evt_abc123def456",
  "timestamp": "2024-01-15T10:35:00Z",
  "eventData": {
    "address": "0x742d35Cc6634C0532925a3b844Bc9e7595f0bEb",
    "amount": "50.00",
    "currency": "USDC",
    "network": "Ethereum",
    "transactionHash": "0x1234567890abcdef1234567890abcdef1234567890abcdef1234567890abcdef",
    "blockNumber": 18500000,
    "blockTimestamp": "2024-01-15T10:34:45Z",
    "confirmations": 12,
    "fromAddress": "0xabcdef1234567890abcdef1234567890abcdef12",
    "toAddress": "0x742d35Cc6634C0532925a3b844Bc9e7595f0bEb",
    "gasUsed": "21000",
    "gasPrice": "30000000000"
  }
}
```

**Payload Fields Explained:**
- `eventType`: Type of webhook event - "stablecoin.usdc.received.success" or "stablecoin.usdt.received.success"
- `eventId`: Unique identifier for this webhook event (for idempotency)
- `timestamp`: When Cashwyre generated this webhook (ISO 8601 format)
- `eventData.address`: Ethereum address that received the payment (this is `card_wallet_address`)
- `eventData.amount`: Payment amount as string (e.g., "50.00")
- `eventData.currency`: Currency code ("USDC" or "USDT")
- `eventData.network`: Blockchain network ("Ethereum")
- `eventData.transactionHash`: Ethereum transaction hash (for verification)
- `eventData.blockNumber`: Ethereum block number where transaction was included
- `eventData.blockTimestamp`: When transaction was mined (ISO 8601)
- `eventData.confirmations`: Number of block confirmations
- `eventData.fromAddress`: Ethereum address that sent the payment
- `eventData.toAddress`: Ethereum address that received the payment (should match `address`)
- `eventData.gasUsed`: Gas used for transaction (in wei)
- `eventData.gasPrice`: Gas price paid (in wei)

**Processing Flow:**
1. Webhook received at `/api/webhooks/cashwyre-payment`
2. Webhook logged to `webhook_logs` table with `processed = false`
3. System extracts `address` from `eventData`
4. System queries `cards` table: `WHERE card_wallet_address = address AND status = 'processing' AND card_code IS NULL`
5. If card found (card creation):
   - Extract `form_data` from card record
   - Get user details from `users` table
   - Call `POST /CustomerCard/createCard` with all data
   - Mark webhook as processed
6. If card not found or already has `card_code` (top-up):
   - Find card by `card_wallet_address` where `card_code IS NOT NULL`
   - Calculate top-up amount (amount - 2.50)
   - Call `POST /CustomerCard/topup`
   - Update card balance and transaction status
   - Mark webhook as processed

---

### Webhook Example 2: Payment Received (Top-up)

**Full Payload:**
```json
{
  "eventType": "stablecoin.usdc.received.success",
  "eventId": "evt_def456ghi789",
  "timestamp": "2024-01-20T15:30:00Z",
  "eventData": {
    "address": "0x742d35Cc6634C0532925a3b844Bc9e7595f0bEb",
    "amount": "50.00",
    "currency": "USDC",
    "network": "Ethereum",
    "transactionHash": "0xabcdef1234567890abcdef1234567890abcdef1234567890abcdef1234567890",
    "blockNumber": 18505000,
    "blockTimestamp": "2024-01-20T15:29:30Z",
    "confirmations": 15,
    "fromAddress": "0x9876543210fedcba9876543210fedcba98765432",
    "toAddress": "0x742d35Cc6634C0532925a3b844Bc9e7595f0bEb",
    "gasUsed": "21000",
    "gasPrice": "32000000000"
  }
}
```

**Processing for Top-up:**
1. Webhook received and logged
2. System finds card by `card_wallet_address = "0x742d35Cc6634C0532925a3b844Bc9e7595f0bEb"`
3. Card has `card_code = "CARD123456789"` (exists, so this is top-up)
4. System calculates: `topUpAmount = parseFloat("50.00") - 2.50 = 47.50`
5. System calls: `POST /CustomerCard/topup` with `cardCode: "CARD123456789", amountInUSD: 47.50`
6. System updates Supabase: `cards.balance = balance + 47.50`
7. System updates Supabase: `transactions.status = 'success' WHERE type = 'top_up' AND status = 'pending'`
8. Webhook marked as processed

---

### Webhook Example 3: Card Created

**Webhook URL:** `https://your-app.vercel.app/api/webhooks/cashwyre-card-created`

**HTTP Method:** POST

**Full Payload:**
```json
{
  "eventType": "virtualcard.created.success",
  "eventId": "evt_ghi789jkl012",
  "timestamp": "2024-01-15T10:40:00Z",
  "eventData": {
    "cardCode": "CARD123456789",
    "CustomerId": "CUST987654321",
    "CustomerEmail": "john@example.com",
    "CardBalance": 50.00,
    "Last4": "1234",
    "ExpiryOn": "12/2025",
    "CardName": "My Personal Card",
    "Status": "active",
    "CardType": "physical",
    "CardBrand": "visa",
    "Currency": "USD",
    "ActivationDate": "2024-01-15T10:40:00Z",
    "CardNumber": null,
    "CVV": null,
    "PIN": null,
    "Metadata": {
      "issuer": "Cashwyre",
      "cardNetwork": "Visa",
      "cardProgram": "Standard",
      "region": "USA"
    }
  }
}
```

**Payload Fields Explained:**
- `cardCode`: **CRITICAL** - Unique card identifier, stored as `cards.card_code` in Supabase. This is used for all future API calls to fetch card details.
- `CustomerId`: Customer identifier in Cashwyre system, stored as `cards.customer_code`
- `CustomerEmail`: User's email address (used to find user in Supabase)
- `CardBalance`: Initial card balance in USD (may be cached in Supabase, but always fetch from API for accuracy)
- `Last4`: Last 4 digits of card number (displayed to user, may be cached)
- `ExpiryOn`: Card expiry date in format "MM/YYYY" (e.g., "12/2025")
- `CardName`: User-defined card name (already stored in Supabase)
- `Status`: Card status - "active" (card ready to use)
- `CardType`: Card type - "physical" (always physical cards)
- `CardBrand`: Card brand - "visa" (always Visa)
- `Currency`: Currency code - "USD" (always USD)
- `ActivationDate`: When card was activated (ISO 8601 timestamp)
- `CardNumber`: Full card number (NOT provided for security - only Last4)
- `CVV`: CVV code (NOT provided for security)
- `PIN`: PIN code (NOT provided for security)
- `Metadata`: Additional card metadata (issuer, network, program, region)

**Processing Flow:**
1. Webhook received at `/api/webhooks/cashwyre-card-created`
2. Webhook logged to `webhook_logs` with `processed = false`
3. System extracts `CustomerEmail` and `cardCode` from `eventData`
4. System queries `users` table: `WHERE email = CustomerEmail.toLowerCase()`
5. If user found:
   - System queries `cards` table: `WHERE user_id = user.id AND status = 'processing' AND card_code IS NULL ORDER BY created_at DESC LIMIT 1`
   - System updates card record:
     ```sql
     UPDATE cards SET
       card_code = 'CARD123456789',
       customer_code = 'CUST987654321',
       status = 'active',
       balance = 50.00,
       last4 = '1234',
       expiry_on = '12/2025'
     WHERE id = card.id
     ```
   - System marks webhook as processed: `UPDATE webhook_logs SET processed = true WHERE event_type = 'virtualcard.created.success'`
6. If user not found:
   - Webhook marked as processed with error: `error_message = 'User not found'`
   - Returns 404 error

**Critical Update:**
The most important update is setting `card_code`. Without this, the card cannot be queried from Cashwyre API. All future operations (getCard, topup, freeze, etc.) require `card_code`.

---

## üîÑ Complete Webhook Processing Flow Diagrams

### Payment Webhook Processing Decision Tree:

```
Payment Webhook Received
(eventType: stablecoin.usdc.received.success)
    ‚Üì
Log Webhook to webhook_logs
(processed = false)
    ‚Üì
Extract: address, amount
    ‚Üì
Find Card by card_wallet_address
    ‚Üì
    ‚îú‚îÄ‚Üí Card NOT Found
    ‚îÇ       ‚Üì
    ‚îÇ   Find Pending Card
    ‚îÇ   (status = 'processing', card_code = null)
    ‚îÇ       ‚Üì
    ‚îÇ   ‚îú‚îÄ‚Üí Found: Card Creation Flow
    ‚îÇ   ‚îÇ       ‚Üì
    ‚îÇ   ‚îÇ   Get User Details
    ‚îÇ   ‚îÇ       ‚Üì
    ‚îÇ   ‚îÇ   Extract form_data from card
    ‚îÇ   ‚îÇ       ‚Üì
    ‚îÇ   ‚îÇ   Call: POST /CustomerCard/createCard
    ‚îÇ   ‚îÇ       ‚Üì
    ‚îÇ   ‚îÇ   Mark Webhook: processed = true
    ‚îÇ   ‚îÇ       ‚Üì
    ‚îÇ   ‚îÇ   Return: "Card creation initiated"
    ‚îÇ   ‚îÇ
    ‚îÇ   ‚îî‚îÄ‚Üí Not Found: Error
    ‚îÇ           ‚Üì
    ‚îÇ       Log Error
    ‚îÇ       Mark Webhook: processed = true, error_message = "Pending card not found"
    ‚îÇ       Return: 404
    ‚îÇ
    ‚îî‚îÄ‚Üí Card Found with card_code: Top-up Flow
            ‚Üì
        Verify card_code exists
            ‚Üì
        Calculate: topUpAmount = amount - 2.50
            ‚Üì
        Call: POST /CustomerCard/topup
        (cardCode, amountInUSD: topUpAmount)
            ‚Üì
        Update Supabase:
        - cards.balance += topUpAmount
        - transactions.status = 'success'
        (WHERE type = 'top_up' AND status = 'pending')
            ‚Üì
        Mark Webhook: processed = true
            ‚Üì
        Return: "Top-up processed successfully"
```

---

### Card Created Webhook Processing Flow:

```
Card Created Webhook Received
(eventType: virtualcard.created.success)
    ‚Üì
Log Webhook to webhook_logs
(processed = false)
    ‚Üì
Extract: cardCode, CustomerEmail
    ‚Üì
Validate Required Fields
(cardCode && CustomerEmail)
    ‚Üì
Find User by Email
(users.email = CustomerEmail.toLowerCase())
    ‚Üì
    ‚îú‚îÄ‚Üí User NOT Found
    ‚îÇ       ‚Üì
    ‚îÇ   Mark Webhook: processed = true, error_message = "User not found"
    ‚îÇ   Return: 404
    ‚îÇ
    ‚îî‚îÄ‚Üí User Found
            ‚Üì
        Verify Card Limit
        (COUNT(cards WHERE user_id = user.id) < 4)
            ‚Üì
            ‚îú‚îÄ‚Üí Limit Exceeded
            ‚îÇ       ‚Üì
            ‚îÇ   Mark Webhook: processed = true, error_message = "Card limit exceeded"
            ‚îÇ   Return: 400
            ‚îÇ
            ‚îî‚îÄ‚Üí Within Limit
                    ‚Üì
                Find Pending Card
                (user_id = user.id, status = 'processing', card_code IS NULL)
                ORDER BY created_at DESC LIMIT 1
                    ‚Üì
                    ‚îú‚îÄ‚Üí Card Found
                    ‚îÇ       ‚Üì
                    ‚îÇ   Update Card:
                    ‚îÇ   - card_code = eventData.cardCode
                    ‚îÇ   - customer_code = eventData.CustomerId
                    ‚îÇ   - status = 'active'
                    ‚îÇ   - balance = eventData.CardBalance
                    ‚îÇ   - last4 = eventData.Last4
                    ‚îÇ   - expiry_on = eventData.ExpiryOn
                    ‚îÇ       ‚Üì
                    ‚îÇ   Mark Webhook: processed = true
                    ‚îÇ       ‚Üì
                    ‚îÇ   Return: "Card created successfully"
                    ‚îÇ
                    ‚îî‚îÄ‚Üí Card NOT Found
                            ‚Üì
                        Mark Webhook: processed = true, error_message = "Pending card not found"
                        Return: 404
```

---

## ‚ö†Ô∏è Error Handling & Edge Cases

### API Error Responses

**Common Error Codes:**
- `VALIDATION_ERROR`: Invalid request data (missing fields, wrong format)
- `CARD_NOT_FOUND`: Card code doesn't exist or card was cancelled
- `INSUFFICIENT_FUNDS`: Not enough funds for operation
- `CARD_FROZEN`: Cannot perform operation on frozen card
- `ALREADY_FROZEN`: Card is already frozen
- `NOT_FROZEN`: Card is not frozen (for unfreeze operation)
- `AUTHENTICATION_ERROR`: Invalid API credentials
- `RATE_LIMIT_EXCEEDED`: Too many requests (should implement retry with backoff)
- `SERVER_ERROR`: Cashwyre server error (should retry)

**Error Response Format:**
```json
{
  "success": false,
  "error": "Human-readable error message",
  "code": "ERROR_CODE",
  "message": "Detailed error description",
  "requestId": "KARDSxxxxxxxxxxxx"
}
```

### Webhook Error Handling

**Webhook Processing Failures:**
- If webhook processing fails, error is logged in `webhook_logs.error_message`
- `processed` flag remains `false` for failed webhooks
- Failed webhooks can be manually reprocessed
- System should implement idempotency (safe to retry same webhook)

**Common Webhook Errors:**
- Card not found: Payment received but no matching card record
- User not found: Card created but user email doesn't exist
- Missing data: Required fields missing from webhook payload
- API call failure: Cashwyre API returns error during webhook processing
- Database error: Supabase update fails

**Webhook Retry Logic:**
- Cashwyre automatically retries failed webhooks (returns non-200 status)
- Retries continue until 200 status is returned
- Should return 200 immediately and process asynchronously if needed
- Or return 200 after successful processing

---

## üîê Security Considerations

### API Authentication

**Bearer Token:**
- Stored in environment variable `CASHWYRE_SECRET_KEY`
- Never exposed to client-side code
- Used in `Authorization: Bearer <token>` header
- Should be rotated periodically
- Should have restricted permissions (only necessary API access)

### Webhook Security

**Current State:**
- ‚ö†Ô∏è **Webhook signature validation is NOT implemented** - security vulnerability
- Anyone who knows webhook URL can send fake webhooks
- Should implement signature verification using Cashwyre's webhook secret

**Recommended Implementation:**
```javascript
// Verify webhook signature
const signature = request.headers['x-cashwyre-signature'];
const expectedSignature = crypto
  .createHmac('sha256', CASHWYRE_WEBHOOK_SECRET)
  .update(JSON.stringify(request.body))
  .digest('hex');

if (signature !== expectedSignature) {
  return 401; // Invalid signature
}
```

**Webhook URL Security:**
- Use HTTPS only (required by Cashwyre)
- Consider adding additional authentication token in URL path
- Monitor for suspicious webhook activity
- Log all webhook attempts (successful and failed)

### Data Privacy

**Sensitive Data:**
- Full card numbers are NEVER returned by Cashwyre API (only Last4)
- CVV codes are NEVER returned
- PIN codes are NEVER returned
- Private keys are encrypted before storage
- Auto-generated data (phone, address, DOB) is NOT stored in Supabase

---

## üìä API Rate Limits & Best Practices

### Rate Limiting

**Cashwyre API Limits:**
- Check Cashwyre documentation for specific rate limits
- Implement exponential backoff on rate limit errors (HTTP 429)
- Cache responses when possible (but NOT for financial data)
- Batch operations when possible

**Current Implementation:**
- Automatic retry: 3 attempts with exponential backoff
- Retry only on network errors, not API errors (4xx/5xx)
- No rate limit handling currently implemented

### Best Practices

**Request ID Generation:**
- Always generate unique request IDs
- Format: `KARDS` + 12 alphanumeric characters
- No dashes or special characters
- Store request IDs for tracking and debugging

**Error Handling:**
- Always handle API errors gracefully
- Log errors for debugging
- Return meaningful error messages to users
- Don't expose internal error details

**Data Validation:**
- Validate all input data before sending to Cashwyre
- Verify card codes exist before operations
- Check user ownership before card operations
- Validate amounts are within acceptable ranges

**Response Handling:**
- Always check `success` field in responses
- Handle null/undefined values
- Verify required fields are present
- Don't assume response structure (validate)

---

## üéØ Integration Checklist

**Cashwyre API Integration:**
- [ ] All environment variables configured (BASE_URL, SECRET_KEY, BUSINESS_CODE, APP_ID)
- [ ] Request ID generation function implemented (`generateRequestId()`)
- [ ] API client function implemented (`callCashwyreAPI()`)
- [ ] Error handling implemented for all API calls
- [ ] Retry logic implemented for network failures
- [ ] All API endpoints tested with valid/invalid inputs

**Webhook Integration:**
- [ ] Webhook URLs configured in Cashwyre dashboard
- [ ] Webhook endpoints implemented (`/api/webhooks/cashwyre-payment`, `/api/webhooks/cashwyre-card-created`)
- [ ] Webhook logging implemented (`webhook_logs` table)
- [ ] Error handling implemented for webhook processing
- [ ] Idempotency checks implemented (prevent duplicate processing)
- [ ] Webhook signature validation implemented (SECURITY)

**Database Integration:**
- [ ] `webhook_logs` table created with all required fields
- [ ] `cards` table has `card_code`, `card_wallet_address`, `form_data` columns
- [ ] Indexes created on frequently queried columns
- [ ] Foreign key constraints set up

**Testing:**
- [ ] Test card creation flow end-to-end
- [ ] Test top-up flow end-to-end
- [ ] Test webhook processing (manual webhook simulation)
- [ ] Test error scenarios (API failures, invalid data)
- [ ] Test edge cases (missing data, duplicate webhooks)

---

*This document provides complete, word-for-word documentation of all Cashwyre API endpoints and webhooks used in the KARDS platform. All API calls, timing, payloads, responses, webhook flows, error handling, and integration details are documented comprehensively above.*
